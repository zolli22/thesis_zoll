---
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = F, warning = F)
```


# Results {#results}

## CNH Tree Data

```{r, include = F}
cnh_all <- read_csv("data/2021_zonal_stats_cnh.csv") %>%
  select(-(9:34))
species_pal <- c("#219EBC", "#023047", "#FFB703", "#FB8500", "#586f7c")


health_pal <- c("#1a005c", "#c80050", "#ffa600", "#586f7c")

ggplot(cnh_all, aes(x = species.x, fill = health_rat))+
  geom_bar()+
  scale_fill_manual(values = health_pal)+
  labs(x = "Species", y = "Count", fill = "Health rating")
```


## Canopy Width and Tree Height Model

I used a third order polynomial regression to predict both tree height and crown width from tree DBH. In order to account for expected differences between species, I included species as an interaction term.
The tree height model has an adjusted R-squared value of 0.78, and a p-value of < 2.2e-16. The crown width model has an adjusted R-squared value of 0.72, and a p-value of < 2.2e-16.

HEY AARON AND ANNA - WHAT AND HOW DO I WRITE ABOUT THIS??

```{r tree-model, include = F}
# load park data, filter to relevant species, and get average crown width.
my_park <- pdxTrees::get_pdxTrees_parks() %>%
  filter(Species %in% c('ACPL', 'THPL', 'PSME', 'ACMA')) %>%
  mutate(crown_width = (Crown_Width_EW+Crown_Width_NS)/2)

# create model for heights
heights <- lm(Tree_Height ~ poly(DBH, degree = 3, raw = T) * Species, data = my_park)

# create model for crown width
cr_width <- lm(crown_width ~ poly(DBH, degree = 3, raw = T) * Species, data = my_park)

# load street data, filter to relevant species
my_street <- pdxTrees::get_pdxTrees_streets() %>%
  filter(Species %in% c('ACPL', 'THPL', 'PSME', 'ACMA'))

# run street trees through both models
my_street <- my_street %>%
  mutate(width_preds = predict(cr_width, my_street, se.fit = FALSE), 
         height_preds = predict(heights, my_street, se.fit = F))

# export data file
# write_csv(my_street, "my_street.csv")

# graphing
p_height_model <- my_park %>% 
  ggplot(aes(x = sqrt(DBH), y = Tree_Height, color = Species)) +
  geom_point(alpha = .1)+
  scale_color_manual(values = species_pal)+
  geom_smooth(method = "lm", se = F, formula = y ~ poly(x, degree = 3, raw = T))+
  labs(subtitle = "Park trees", y = "Tree Height Measurement")+
  guides(color = "none")

p_width_model <- my_park %>% 
  ggplot(aes(x = sqrt(DBH), y = crown_width, color = Species)) +
  geom_point(alpha = .1)+
  scale_color_manual(values = species_pal)+
  geom_smooth(method = "lm", se = F, formula = y ~ poly(x, degree = 3, raw = T))+
  labs(subtitle = "Park trees", y = "Canopy Width Measurement")+
  guides(color = "none")

s_height_preds <- my_street %>% 
  ggplot(aes(x = sqrt(DBH), y = height_preds, color = Species)) +
  geom_point(alpha = .3)+
  scale_color_manual(values = species_pal)+
  labs(subtitle = "Street trees", y = "Tree Height Prediction")

s_width_preds <- my_street %>% 
  ggplot(aes(x = sqrt(DBH), y = width_preds, color = Species)) +
  geom_point(alpha = .3)+
  scale_color_manual(values = species_pal)+
  labs(subtitle = "Park trees", y = "Canopy Width Prediction")
```

```{r height-model, echo = F, fig.cap="Tree height predictive model"}
p_height_model + s_height_preds 
```
```{r width-model, echo = F, fig.cap="Crown width predictive model"}
p_width_model + s_width_preds
```

## NDVI Calculation



## Point Method

```{r}
cnh_point <- read_csv("data/cnh_point.csv") %>%
  mutate(health_rat = fct_relevel(health_rat, levels = c("poor", "fair", "good"))) %>%
  filter(!is.na(health_rat))

cnh_point %>%
  ggplot(aes(x = health_rat, y = sample_ndvi))+
  geom_boxplot()+
  #geom_point(aes(color = species))+
  theme_minimal()+
  labs(title = "Average NDVI measurement for CNH trees, by assigned health rating", x = "Health Rating", y = "Mean NDVI")

# 2
cnh_point %>%
  ggplot(aes(x = health_rat, y = sample_ndvi))+
  geom_boxplot()+
  #geom_point(aes(color = species))+
  facet_wrap(~species)+
  theme_minimal()+
  labs(title = "CNH average NDVI by health condition and species", x = "Health Rating", y = "Mean NDVI")
```


## Radius Method

```{r}
cnh_radius <- read_csv("data/cnh_radius.csv")
```

## LiDAR Method

```{r}
cnh_lidar <- read_csv("data/cnh_lidar.csv")
```

## Predictive Model
